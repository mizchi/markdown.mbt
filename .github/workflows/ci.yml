name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install MoonBit CLI
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
      - name: Install dependencies
        run: pnpm install
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: "pnpm"
      - name: Generate CommonMark tests
        run: node scripts/gen-tests.js
      - name: Generate GFM tests
        run:  node scripts/gen-gfm-tests.js
      - name: Check
        run: |
          moon update
          moon check
      - name: Test all
        run: |
          moon test src --target js,native,wasm-gc
      - name: Moon test
        run: |
          moon test src/cmark_tests --target js
      - name: Moon test
        run: |
          moon test src/gfm_tests --target js
      - name: Moon test
        run: |
          moon test src/html_tests --target js
      - name: Moon test
        run: |
          moon test src/tui --target all
      - name: Test Bench
        run: moon bench
      - name: Install moon-component
        run: |
          curl -fsSL -o /tmp/moon-component.tar.gz \
            https://github.com/mizchi/moon-component/releases/download/v0.3.0/moon-component-linux-x64.tar.gz
          tar -xzf /tmp/moon-component.tar.gz -C /usr/local/bin
          chmod +x /usr/local/bin/moon-component
      - name: Component build and test
        run: |
          cd component
          moon-component generate wit --out-dir . --no-impl
          moon build --target wasm --release
          moon-component componentize _build/wasm/release/build/impl/impl.wasm --wit-dir wit -o markdown-component.wasm
          npx jco transpile markdown-component.wasm -o test/gen
          node test/test.mjs
