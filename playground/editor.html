<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lightweight Code Editor</title>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --border-color: #30363d;
      --line-number-bg: #161b22;
      --line-number-color: #484f58;
      --selection-bg: rgba(56, 139, 253, 0.3);
      --cursor-color: #c9d1d9;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      gap: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    select {
      padding: 8px 12px;
      font-size: 14px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }

    /* Editor Container */
    .editor-container {
      flex: 1;
      display: flex;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-primary);
      min-height: 400px;
    }

    /* Line Numbers */
    .line-numbers {
      background: var(--line-number-bg);
      color: var(--line-number-color);
      padding: 16px 0;
      text-align: right;
      user-select: none;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
      min-width: 50px;
      border-right: 1px solid var(--border-color);
    }

    .line-numbers .line-number {
      padding: 0 12px 0 8px;
    }

    /* Editor Wrapper - contains both textarea and highlight layer */
    .editor-wrapper {
      flex: 1;
      position: relative;
      overflow: auto;
    }

    /* Shared styles for textarea and highlight layer */
    .editor-textarea,
    .editor-highlight {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 16px;
      margin: 0;
      border: none;
      white-space: pre;
      word-wrap: normal;
      overflow-wrap: normal;
      tab-size: 2;
    }

    /* Hidden textarea for input */
    .editor-textarea {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      color: transparent;
      caret-color: var(--cursor-color);
      resize: none;
      outline: none;
      z-index: 2;
    }

    .editor-textarea::selection {
      background: var(--selection-bg);
    }

    /* During IME composition */
    .editor-wrapper.composing .editor-textarea {
      color: var(--text-primary);
    }

    .editor-wrapper.composing .editor-highlight {
      opacity: 0.3;
    }

    /* Visible highlight layer */
    .editor-highlight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 100%;
      pointer-events: none;
      z-index: 1;
      color: var(--text-primary);
    }

    /* Ensure pre doesn't add extra margin */
    .editor-highlight pre {
      margin: 0;
      padding: 0;
      font: inherit;
      background: transparent;
    }

    .editor-highlight code {
      font: inherit;
    }

    /* IME composition indicator */
    .ime-indicator {
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .ime-indicator.active {
      opacity: 1;
    }

    /* Status bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Code Editor</h1>
      <div class="controls">
        <label for="lang">Language:</label>
        <select id="lang">
          <option value="typescript">TypeScript</option>
          <option value="moonbit">MoonBit</option>
          <option value="rust">Rust</option>
          <option value="json">JSON</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="bash">Bash</option>
        </select>
      </div>
    </header>

    <div class="editor-container">
      <div class="line-numbers" id="lineNumbers"></div>
      <div class="editor-wrapper">
        <div class="editor-highlight" id="highlight"></div>
        <textarea
          class="editor-textarea"
          id="editor"
          spellcheck="false"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
        ></textarea>
      </div>
    </div>

    <div class="status-bar">
      <span id="cursorPos">Line 1, Column 1</span>
      <span id="status">Ready</span>
    </div>

    <div class="ime-indicator" id="imeIndicator">IME: Composing...</div>
  </div>

  <script type="module">
    import { highlight } from '../js/lezer_api.js';

    const editor = document.getElementById('editor');
    const editorWrapper = document.querySelector('.editor-wrapper');
    const highlightEl = document.getElementById('highlight');
    const lineNumbersEl = document.getElementById('lineNumbers');
    const cursorPosEl = document.getElementById('cursorPos');
    const statusEl = document.getElementById('status');
    const imeIndicator = document.getElementById('imeIndicator');
    const langSelect = document.getElementById('lang');

    let currentLang = 'typescript';
    let isComposing = false;
    let compositionText = '';

    // Initial content
    const initialCode = `interface User {
  id: number;
  name: string;
}

function greet(user: User): string {
  return \`Hello, \${user.name}!\`;
}

const user: User = { id: 1, name: "World" };
console.log(greet(user));
`;

    editor.value = initialCode;

    // =========================================================================
    // Highlight Function
    // =========================================================================

    function updateHighlight() {
      // Skip during IME composition
      if (isComposing) return;

      const code = editor.value;

      try {
        const html = highlight(code, currentLang);
        // Extract just the code content from the shiki output
        const match = html.match(/<code>([\s\S]*)<\/code>/);
        if (match) {
          highlightEl.innerHTML = '<pre><code>' + match[1] + '</code></pre>';
        } else {
          highlightEl.innerHTML = '<pre><code>' + escapeHtml(code) + '</code></pre>';
        }
      } catch (e) {
        console.error('Highlight error:', e);
        highlightEl.innerHTML = '<pre><code>' + escapeHtml(code) + '</code></pre>';
      }
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // =========================================================================
    // Line Numbers
    // =========================================================================

    function updateLineNumbers() {
      const lines = editor.value.split('\n');
      const lineCount = lines.length;

      let html = '';
      for (let i = 1; i <= lineCount; i++) {
        html += `<div class="line-number">${i}</div>`;
      }
      lineNumbersEl.innerHTML = html;
    }

    // =========================================================================
    // Cursor Position
    // =========================================================================

    function updateCursorPosition() {
      const text = editor.value;
      const pos = editor.selectionStart;

      // Count lines and column
      const beforeCursor = text.substring(0, pos);
      const lines = beforeCursor.split('\n');
      const line = lines.length;
      const column = lines[lines.length - 1].length + 1;

      cursorPosEl.textContent = `Line ${line}, Column ${column}`;
    }

    // =========================================================================
    // Scroll Sync
    // =========================================================================

    function syncScroll() {
      highlightEl.style.transform = `translate(${-editor.scrollLeft}px, ${-editor.scrollTop}px)`;
      lineNumbersEl.style.transform = `translateY(${-editor.scrollTop}px)`;
    }

    // =========================================================================
    // IME Handling
    // =========================================================================

    editor.addEventListener('compositionstart', (e) => {
      isComposing = true;
      editorWrapper.classList.add('composing');
      imeIndicator.classList.add('active');
      statusEl.textContent = 'IME: Composing...';
    });

    editor.addEventListener('compositionupdate', (e) => {
      // Don't update highlight during composition - let textarea show
    });

    editor.addEventListener('compositionend', (e) => {
      isComposing = false;
      editorWrapper.classList.remove('composing');
      imeIndicator.classList.remove('active');
      statusEl.textContent = 'Ready';

      updateHighlight();
      updateLineNumbers();
    });

    // =========================================================================
    // Event Handlers
    // =========================================================================

    editor.addEventListener('input', (e) => {
      // Skip highlight update during IME composition
      if (!isComposing) {
        updateHighlight();
        updateLineNumbers();
      }
      updateCursorPosition();
    });

    editor.addEventListener('scroll', syncScroll);

    editor.addEventListener('keyup', updateCursorPosition);
    editor.addEventListener('click', updateCursorPosition);
    editor.addEventListener('select', updateCursorPosition);

    // Handle tab key
    editor.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart;
        const end = editor.selectionEnd;

        // Use setRangeText for reliable insertion
        editor.setRangeText('  ', start, end, 'end');

        updateHighlight();
        updateLineNumbers();
        updateCursorPosition();
      }
    });

    // Language change
    langSelect.addEventListener('change', (e) => {
      currentLang = e.target.value;
      updateHighlight();
    });

    // =========================================================================
    // Initialize
    // =========================================================================

    updateHighlight();
    updateLineNumbers();
    updateCursorPosition();
    editor.focus();

    console.log('Editor initialized');
  </script>
</body>
</html>
